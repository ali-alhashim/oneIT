<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/header :: head}">


</head>
<body class="bg-body-secondary">

<div th:replace="~{fragments/header :: header}"></div>

<div class=" bordered my-5 ">

  <!--Add Form-->
  <div class="row rounded border p-4 bg-light">
    <form method="post" enctype="multipart/form-data" th:object="${payslipDto}" th:with="_csrfToken=${_csrf.token}">

      <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrfToken}" />


      <div class="form-floating my-1">
        <input type="text" class="form-control" id="codeName"  name="codeName" th:field="${payslipDto.codeName}">
        <label for="codeName">Code Name</label>
        <p th:if="${#fields.hasErrors('codeName')}" th:errorclass="text-danger" th:errors="${payslipDto.codeName}"></p>
      </div>

      <div class="form-floating my-1">
        <input type="date" class="form-control" id="periodStart"  name="periodStart" th:field="${payslipDto.periodStart}">
        <label for="periodStart">Period Start</label>
        <p th:if="${#fields.hasErrors('periodStart')}" th:errorclass="text-danger" th:errors="${payslipDto.periodStart}"></p>
      </div>

      <div class="form-floating my-1">
        <input type="date" class="form-control" id="periodEnd"  name="periodEnd" th:field="${payslipDto.periodEnd}">
        <label for="periodEnd">Period End</label>
        <p th:if="${#fields.hasErrors('periodEnd')}" th:errorclass="text-danger" th:errors="${payslipDto.periodEnd}"></p>
      </div>



      <div class="form-floating my-1">
        <select class="form-select" id="departmentId"  name="departmentId" th:field="${payslipDto.departmentId}" onchange="fetchDepartmentEmployees(this)">
          <option value="0">Select Department...</option>
          <option th:each="department: ${departments}" th:value="${department.id}" th:text="${department.name}"></option>
        </select>
        <label for="departmentId">Department</label>
        <p th:if="${#fields.hasErrors('departmentId')}" th:errorclass="text-danger" th:errors="${payslipDto.departmentId}"></p>
      </div>


       <hr>
        <table class="table">
          <thead>
             <tr>
               <th>Badge#</th>
               <th>Name</th>
               <th>Bank Name</th>
               <th>IBAN</th>
               <th>Salary Package</th>
               <th>Payslip</th>
               <th>Action</th>
             </tr>
          </thead>
          <tbody id="tBody">

          </tbody>
        </table>
       <hr>




      <div class="row justify-content-between my-3">
        <div class="col-sm-4 d-grid">
          <button type="submit" class="btn btn-primary">Submit</button>
        </div>
        <div class="col-sm-4  d-grid">
          <a class="btn btn-outline-primary" href="/payslip/list" role="button">Cancel</a>
        </div>
      </div>



    </form>
  </div>
  <!--/Add Form -->

</div>

<script>
  function fetchDepartmentEmployees(selectInput) {
    const departmentId = selectInput.value;
    const url = `/payslip/getDepartmentEmployees?departmentId=${departmentId}`;
    const tBody = document.getElementById("tBody");

    // Clear the table body before populating it
    tBody.innerHTML = '';

    // Only fetch if a valid department is selected
    if (departmentId !== "0") {
      fetch(url)
        .then(response => {
          if (!response.ok) {
            alert('Department not found');
            throw new Error('Department not found');
          }
          return response.json(); // returns the parsed JSON data
        })
        .then(data => {
          data.forEach(employee => {
            console.log(employee);
            const row = document.createElement('tr');

            row.innerHTML = `
                <td>${employee.badgeNumber}</td>
                <td>${employee.name}</td>
                <td>${employee.bankName || 'N/A'}</td>
                <td>${employee.iban || 'N/A'}</td>
                <td>${employee.basicSalary ? employee.basicSalary : 'N/A'}</td>
                <td>
                    <input type="file" name="payslip_${employee.id}" accept=".pdf"/>
                </td>
                <td>
                    <button type="button" class="btn btn-danger" onclick="CalculateMinutes(this)">Calculate and deduct missing minutes</button>
                </td>
            `;

            // Append the row to the table body
            tBody.appendChild(row);
          });
        })
        .catch(error => {
          console.error('Error fetching employees:', error);
          alert("Failed to load employees. Please try again.");
        });
    }
  }
</script>

<div th:replace="~{fragments/footer :: footer}"></div>
</body>
</html>