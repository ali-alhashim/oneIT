<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/header :: head}">


</head>
<body class="bg-body-secondary">

<div th:replace="~{fragments/header :: header}"></div>

<div class=" bordered my-5 ">

  <!--Add Form-->
  <div class="row rounded border p-4 bg-light">
    <form method="post" enctype="multipart/form-data" th:object="${payslipDto}" th:with="_csrfToken=${_csrf.token}">

      <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrfToken}" />


      <div class="form-floating my-1">
        <input type="text" class="form-control" id="codeName"  name="codeName" th:field="${payslipDto.codeName}">
        <label for="codeName">Code Name</label>
        <p th:if="${#fields.hasErrors('codeName')}" th:errorclass="text-danger" th:errors="${payslipDto.codeName}"></p>
      </div>

      <div class="form-floating my-1">
        <input type="date" class="form-control" id="periodStart"  name="periodStart" th:field="${payslipDto.periodStart}">
        <label for="periodStart">Period Start</label>
        <p th:if="${#fields.hasErrors('periodStart')}" th:errorclass="text-danger" th:errors="${payslipDto.periodStart}"></p>
      </div>

      <div class="form-floating my-1">
        <input type="date" class="form-control" id="periodEnd"  name="periodEnd" th:field="${payslipDto.periodEnd}">
        <label for="periodEnd">Period End</label>
        <p th:if="${#fields.hasErrors('periodEnd')}" th:errorclass="text-danger" th:errors="${payslipDto.periodEnd}"></p>
      </div>



      <div class="form-floating my-1">
        <select class="form-select" id="departmentId"  name="departmentId" th:field="${payslipDto.departmentId}" onchange="fetchDepartmentEmployees(this)">
          <option value="0">Select Department...</option>
          <option th:each="department: ${departments}" th:value="${department.id}" th:text="${department.name}"></option>
        </select>
        <label for="departmentId">Department</label>
        <p th:if="${#fields.hasErrors('departmentId')}" th:errorclass="text-danger" th:errors="${payslipDto.departmentId}"></p>
      </div>


       <hr>
        <table class="table">
          <thead>
             <tr>
               <th>Badge#</th>
               <th>Name</th>
               <th>Bank Name</th>
               <th>IBAN</th>
               <th>Basic Salary</th>
               <th>Benefits</th>
               <th>After Deduct M.M [Basic Salary]</th>
               <th>Total MM</th>
               <th>Action</th>
             </tr>
          </thead>
          <tbody id="tBody">

          </tbody>
        </table>
       <hr>




      <div class="row justify-content-between my-3">
        <div class="col-sm-4 d-grid">
          <button type="submit" class="btn btn-primary">Submit</button>
        </div>


        <div class="col-sm-4  d-grid">
          <button type="button" class="btn btn-danger" onclick="CalculateMinutesAll()">Calculate and deduct missing minutes All</button>
        </div>


        <div class="col-sm-4  d-grid">
          <a class="btn btn-outline-primary" href="/payslip/list" role="button">Cancel</a>
        </div>


      </div>



    </form>
  </div>
  <!--/Add Form -->

</div>

<script>
  function fetchDepartmentEmployees(selectInput) {
    const departmentId = selectInput.value;
    const url = `/payslip/getDepartmentEmployees?departmentId=${departmentId}`;
    const tBody = document.getElementById("tBody");

    // Clear the table body before populating it
    tBody.innerHTML = '';

    // Only fetch if a valid department is selected
    if (departmentId !== "0") {
      fetch(url)
        .then(response => {
          if (!response.ok) {
            alert('Department not found');
            throw new Error('Department not found');
          }
          return response.json(); // returns the parsed JSON data
        })
        .then(data => {
          data.forEach(employee => {
            console.log(employee);
            const row = document.createElement('tr');

            // Basic employee info
            row.innerHTML = `
                <td>${employee.badgeNumber}</td>
                <td>${employee.name}</td>
                <td>${employee.bankName || 'N/A'}</td>
                <td>${employee.iban || 'N/A'}</td>
                <td>${employee.basicSalary ? employee.basicSalary : 'N/A'}</td>
                <td>
                  <table class="table">
                    <thead>
                      <tr>
                        <th>Pay Description</th>
                        <th>To Pay</th>
                        <th>To Deduct</th>
                      </tr>
                    </thead>
                    <tbody id="benefits-${employee.id}">
                      <!-- Benefits will be inserted here -->
                    </tbody>
                  </table>
                </td>
                <td>
                    <input type="text" name="DeductedBasicSalary_${employee.badgeNumber}" value="${employee.basicSalary}"/>
                </td>
                 <td>
                    <input type="text" name="TotalMM_${employee.badgeNumber}"/>
                </td>
                <td>
                    <button type="button" class="btn btn-danger" onclick="CalculateMinutes('${employee.badgeNumber}')">Calculate and deduct missing minutes</button>
                </td>
            `;

            // Append the row to the table body
            tBody.appendChild(row);

            // Handle benefits
            const benefitsTBody = document.getElementById(`benefits-${employee.id}`);
            employee.benefits.forEach(benefit => {
              const benefitRow = document.createElement('tr');
              benefitRow.innerHTML = `
                <td>${benefit.payDescription}</td>
                <td>${benefit.toPay}</td>
                <td>${benefit.toDeduct}</td>
              `;
              benefitsTBody.appendChild(benefitRow);
            });

          });
        })
        .catch(error => {
          console.error('Error fetching employees:', error);
          alert("Failed to load employees. Please try again.");
        });
    }
  }

// CalculateMinutes ------------------------

  function CalculateMinutes(badgeNumber) {
    const periodStart = document.getElementById("periodStart").value;
    const periodEnd = document.getElementById("periodEnd").value;

    if (!periodStart || !periodEnd) {
        alert("Please select both start and end dates.");
        return;
    }

    const url = `/payslip/CalculateMinutes?badgeNumber=${badgeNumber}&periodStart=${periodStart}&periodEnd=${periodEnd}`;

    fetch(url)
        .then(response => {
            if (!response.ok) {
                throw new Error(`Error: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            // Assuming server returns {deductedBasicSalary, totalMM}
            const deductedSalaryInput = document.querySelector(`input[name="DeductedBasicSalary_${badgeNumber}"]`);
            const totalMMInput = document.querySelector(`input[name="TotalMM_${badgeNumber}"]`);

            if (deductedSalaryInput && totalMMInput) {
                deductedSalaryInput.value = data.deductedBasicSalary;
                totalMMInput.value = data.totalMM;
            } else {
                alert("Error updating the table. Please refresh the page.");
            }
        })
        .catch(error => {
            console.error("Error during calculation:", error);
            alert("Failed to calculate missing minutes. Please try again.");
        });
}

// CalculateMinutes ------------------------


function CalculateMinutesAll() {
    const periodStart = document.getElementById("periodStart").value;
    const periodEnd = document.getElementById("periodEnd").value;
    const departmentId = document.getElementById("departmentId").value;

    // Validate input fields
    if (!periodStart || !periodEnd || !departmentId) {
        alert("Please fill out all fields.");
        return;
    }

    // Prepare the request parameters
    const url = `/payslip/CalculateMinutesAll?departmentId=${departmentId}&periodStart=${encodeURIComponent(periodStart)}&periodEnd=${encodeURIComponent(periodEnd)}`;

    // Send AJAX request
    fetch(url, {
        method: "GET",
        headers: {
            "Content-Type": "application/json"
        }
    })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json(); // Parse JSON response
        })
        .then(data => {

           console.log("CalculateMinutesAll Response Data:", data);

            // Update UI elements

            data.forEach(item => {
             //console.log(`Badge: ${item.badgeNumber}, Deducted Salary: ${item.deductedBasicSalary}, Total MM: ${item.totalMM}`);

             const deductedSalaryInput = document.querySelector(`input[name="DeductedBasicSalary_${item.badgeNumber}"]`);
             const totalMMInput = document.querySelector(`input[name="TotalMM_${item.badgeNumber}"]`);

            if (deductedSalaryInput && totalMMInput)
            {
                deductedSalaryInput.value = item.deductedBasicSalary;
                totalMMInput.value = item.totalMM;
            }


            });

        })
        .catch(error => {
            // Handle errors
            console.error("Error:", error);
            alert("An error occurred while calculating minutes. Please try again.");
        });
}


</script>

<div th:replace="~{fragments/footer :: footer}"></div>
</body>
</html>