<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/header :: head}">
</head>

<link rel="stylesheet" th:href="@{/leaflet/leaflet.css}" />
<script th:src="@{/leaflet/leaflet.js}"></script>
<link rel="stylesheet" th:href="@{/leaflet/leaflet.draw.css}" />
<script th:src="@{/leaflet/leaflet.draw.js}"></script>

<body class="bg-body-secondary">

<div th:replace="~{fragments/header :: header}"></div>



<div class="container bordered my-5">




  <div class="row rounded border p-4 bg-light">
    <form method="post" th:object="${geolocationDto}" th:with="_csrfToken=${_csrf.token}">
      <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrfToken}" />


      <div id="map" style="height: 400px; margin-bottom: 20px;"></div>



      <div class="form-floating my-1">
        <input type="text" class="form-control" id="name"  name="areaName" th:field="${geolocationDto.areaName}">
        <label for="name">Area Name</label>
        <p th:if="${#fields.hasErrors('areaName')}" th:errorclass="text-danger" th:errors="${geolocationDto.areaName}"></p>
      </div>

      <table class="table">
        <thead>
        <tr>
          <th>#</th>
          <th>A</th>
          <th>B</th>
          <th>C</th>
          <th>D</th>
        </tr>
        </thead>
        <tbody>

        <tr>
          <td>latitude</td>
          <td><input type="text" name="latitudeA" id="latitudeA" th:field="${geolocationDto.latitudeA}"/></td>
          <td><input type="text" name="latitudeB" id="latitudeB" th:field="${geolocationDto.latitudeB}"/></td>
          <td><input type="text" name="latitudeC" id="latitudeC" th:field="${geolocationDto.latitudeC}"/></td>
          <td><input type="text" name="latitudeD" id="latitudeD" th:field="${geolocationDto.latitudeD}"/></td>
        </tr>

        <tr>
          <td>longitude</td>
          <td><input type="text" name="longitudeA" id="longitudeA" th:field="${geolocationDto.longitudeA}"/></td>
          <td><input type="text" name="longitudeB" id="longitudeB" th:field="${geolocationDto.longitudeB}"/></td>
          <td><input type="text" name="longitudeC" id="longitudeC" th:field="${geolocationDto.longitudeC}"/></td>
          <td><input type="text" name="longitudeD" id="longitudeD" th:field="${geolocationDto.longitudeD}"/></td>
        </tr>

        </tbody>
      </table>
      <hr>

      <input type="submit" value="save" class="btn btn-success">
    </form>
  </div>






</div>



<div th:replace="~{fragments/footer :: footer}"></div>


<script>
  document.addEventListener("DOMContentLoaded", function () {
      // Define the map layers
      var osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          maxZoom: 19,
          attribution: 'Â© OpenStreetMap'
      });

      var satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
          attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
      });

      // Initialize the map
      var map = L.map('map', {
          center: [24.7136, 46.6753],
          zoom: 10,
          layers: [satelliteLayer] // Default layer
      });

      // Layer control to toggle between layers
      var baseMaps = {
          "OpenStreetMap": osmLayer,
          "Satellite": satelliteLayer
      };
      L.control.layers(baseMaps).addTo(map);


       // Fetch geolocation coordinates from Thymeleaf variables
      const latitudeA = parseFloat([[${geolocationDto.latitudeA}]]);
      const longitudeA = parseFloat([[${geolocationDto.longitudeA}]]);
      const latitudeB = parseFloat([[${geolocationDto.latitudeB}]]);
      const longitudeB = parseFloat([[${geolocationDto.longitudeB}]]);
      const latitudeC = parseFloat([[${geolocationDto.latitudeC}]]);
      const longitudeC = parseFloat([[${geolocationDto.longitudeC}]]);
      const latitudeD = parseFloat([[${geolocationDto.latitudeD}]]);
      const longitudeD = parseFloat([[${geolocationDto.longitudeD}]]);

       // Check if any coordinates are invalid
      if (!latitudeA || !longitudeA || !latitudeB || !longitudeB || !latitudeC || !longitudeC || !latitudeD || !longitudeD) {
          console.error("Invalid geolocation coordinates");
          return;
      }

        // Define rectangle corners
      const bounds = [
          [latitudeA, longitudeA], // Point A
          [latitudeB, longitudeB], // Point B
          [latitudeC, longitudeC], // Point C
          [latitudeD, longitudeD]  // Point D
      ];

       // Add rectangle to the map
      const rectangle = L.polygon(bounds, { color: 'blue', weight: 2 });
      rectangle.addTo(map);



      // Feature group for drawn items
      var drawnItems = new L.FeatureGroup();
      map.addLayer(drawnItems);

      // Draw control
      var drawControl = new L.Control.Draw({
          draw: { rectangle: { shapeOptions: { color: '#3388ff', weight: 2, fillOpacity: 0.2 } } },
          edit: { featureGroup: drawnItems }
      });
      map.addControl(drawControl);

      // Handle drawing events
      map.on(L.Draw.Event.CREATED, function (event) {
          var layer = event.layer;
          var bounds = layer.getBounds();
          var northEast = bounds.getNorthEast();
          var southWest = bounds.getSouthWest();

          document.getElementById('latitudeA').value = northEast.lat;
          document.getElementById('longitudeA').value = northEast.lng;

          document.getElementById('latitudeB').value = northEast.lat;
          document.getElementById('longitudeB').value = southWest.lng;

          document.getElementById('latitudeC').value = southWest.lat;
          document.getElementById('longitudeC').value = southWest.lng;

          document.getElementById('latitudeD').value = southWest.lat;
          document.getElementById('longitudeD').value = northEast.lng;

          drawnItems.clearLayers(); // Remove previous shapes
          drawnItems.addLayer(layer); // Add new shape
      });


       // Adjust map view to fit the rectangle
      map.fitBounds(rectangle.getBounds());


  });
</script>
</body>
</html>