<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/header :: head}">
</head>

<link rel="stylesheet" th:href="@{/leaflet/leaflet.css}" />
<script th:src="@{/leaflet/leaflet.js}"></script>
<link rel="stylesheet" th:href="@{/leaflet/leaflet.draw.css}" />
<script th:src="@{/leaflet/leaflet.draw.js}"></script>

<body class="bg-body-secondary">

<div th:replace="~{fragments/header :: header}"></div>



<div class="container bordered my-5">




  <div class="row rounded border p-4 bg-light">
     <form method="post" th:object="${geolocationDto}" th:with="_csrfToken=${_csrf.token}">
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrfToken}" />


        <div id="map" style="height: 400px; margin-bottom: 20px;"></div>



       <div class="form-floating my-1">
         <input type="text" class="form-control" id="name"  name="areaName" th:field="${geolocationDto.areaName}">
         <label for="name">Area Name</label>
         <p th:if="${#fields.hasErrors('areaName')}" th:errorclass="text-danger" th:errors="${geolocationDto.areaName}"></p>
       </div>

       <table class="table">
         <thead>
           <tr>
             <th>#</th>
             <th>A</th>
             <th>B</th>
             <th>C</th>
             <th>D</th>
           </tr>
         </thead>
         <tbody>

         <tr>
           <td>latitude</td>
           <td><input type="text" name="latitudeA" id="latitudeA"/></td>
           <td><input type="text" name="latitudeB" id="latitudeB"/></td>
           <td><input type="text" name="latitudeC" id="latitudeC"/></td>
           <td><input type="text" name="latitudeD" id="latitudeD"/></td>
         </tr>

         <tr>
           <td>longitude</td>
           <td><input type="text" name="longitudeA" id="longitudeA"/></td>
           <td><input type="text" name="longitudeB" id="longitudeB"/></td>
           <td><input type="text" name="longitudeC" id="longitudeC"/></td>
           <td><input type="text" name="longitudeD" id="longitudeD"/></td>
         </tr>

         </tbody>
       </table>
       <hr>

       <input type="submit" value="save" class="btn btn-success">
     </form>
  </div>






</div>



<div th:replace="~{fragments/footer :: footer}"></div>


<script>
  document.addEventListener("DOMContentLoaded", function () {
      // Define the map layers
      var osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          maxZoom: 19,
          attribution: 'Â© OpenStreetMap'
      });

      var satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
          attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
      });

      // Initialize the map
      var map = L.map('map', {
          center: [24.7136, 46.6753],
          zoom: 10,
          layers: [osmLayer] // Default layer
      });

      // Layer control to toggle between layers
      var baseMaps = {
          "OpenStreetMap": osmLayer,
          "Satellite": satelliteLayer
      };
      L.control.layers(baseMaps).addTo(map);

      // Feature group for drawn items
      var drawnItems = new L.FeatureGroup();
      map.addLayer(drawnItems);

      // Draw control
      var drawControl = new L.Control.Draw({
          draw: { rectangle: { shapeOptions: { color: '#3388ff', weight: 2, fillOpacity: 0.2 } } },
          edit: { featureGroup: drawnItems }
      });
      map.addControl(drawControl);

      // Handle drawing events
      map.on(L.Draw.Event.CREATED, function (event) {
          var layer = event.layer;
          var bounds = layer.getBounds();
          var northEast = bounds.getNorthEast();
          var southWest = bounds.getSouthWest();

          document.getElementById('latitudeA').value = northEast.lat;
          document.getElementById('longitudeA').value = northEast.lng;

          document.getElementById('latitudeB').value = northEast.lat;
          document.getElementById('longitudeB').value = southWest.lng;

          document.getElementById('latitudeC').value = southWest.lat;
          document.getElementById('longitudeC').value = southWest.lng;

          document.getElementById('latitudeD').value = southWest.lat;
          document.getElementById('longitudeD').value = northEast.lng;

          drawnItems.clearLayers(); // Remove previous shapes
          drawnItems.addLayer(layer); // Add new shape
      });

      // Geolocation to locate user
      function locateUser() {
          if (navigator.geolocation) {
              navigator.geolocation.getCurrentPosition(function (position) {
                  var lat = position.coords.latitude;
                  var lng = position.coords.longitude;

                  // Center map on user's location
                  map.setView([lat, lng], 15);

                  // Add a marker at the user's location
                  var userMarker = L.marker([lat, lng], {
                      title: "You are here",
                      icon: L.icon({
                          iconUrl: '/icons/location.png',  // Ensure this path is valid
                          iconSize: [30, 30],
                          iconAnchor: [15, 30]
                      })
                  }).addTo(map).bindPopup("You are here").openPopup();
              }, function (error) {
                  alert("Unable to retrieve your location. Please allow location access.");
              });
          } else {
              alert("Geolocation is not supported by your browser.");
          }
      }

      // Locate user on page load
      locateUser();
  });
</script>
</body>
</html>